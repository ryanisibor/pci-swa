<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PCI Firewall Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <style>
  body {
    background-color: #f3f4f6;   /* Light gray */
    color: #1f2937;              /* Dark gray text */
  }

  .card {
    background-color: #ffffff;   /* White cards */
    border: 1px solid #d1d5db;   /* Light border */
    border-radius: 8px;
  }

  .form-label {
    font-weight: 600;
    color: #111827;
  }

  .zone-badge {
    font-size: 0.8rem;
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    font-weight: 600;
  }

  /* PCI Zones */
  .zone-CDE {
    background-color: #dc2626;   /* Brighter red */
    color: #ffffff;
  }

  .zone-CSE {
    background-color: #d97706;   /* Bright amber */
    color: #ffffff;
  }

  .zone-none {
    background-color: #6b7280;   /* Medium gray */
    color: #ffffff;
  }

  /* Preformatted diagnostic area */
  pre {
    background-color: #f9fafb;   /* Light panel */
    color: #111827;
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    font-size: 0.85rem;
    max-height: 300px;
    overflow: auto;
  }

  /* Subtle muted text */
  .text-secondary {
    color: #4b5563 !important;
  }
</style>
</head>
<body class="py-4">
  <div class="container" style="max-width: 900px;">
    <h1 class="mb-1">PCI Firewall Rule Helper</h1>
    <p class="text-secondary mb-4">
      Enter source and destination IPs from a firewall request. This tool looks
      them up against the PCI network index and shows potential PCI impact.
    </p>

    <div class="card mb-3">
      <div class="card-body">
        <form id="firewallForm">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="srcIp" class="form-label">Source IP</</label>
              <input
                type="text"
                class="form-control"
                id="srcIp"
                placeholder="e.g. 172.20.214.5"
                required
              />
            </div>
            <div class="col-md-4">
              <label for="dstIp" class="form-label">Destination IP</label>
              <input
                type="text"
                class="form-control"
                id="dstIp"
                placeholder="e.g. 10.88.16.5"
                required
              />
            </div>
            <div class="col-md-4">
              <label for="context" class="form-label">Context (optional)</label>
              <input
                type="text"
                class="form-control"
                id="context"
                placeholder="e.g. SSH admin for support"
              />
            </div>
          </div>

          <div class="mt-3 d-flex align-items-center gap-3">
            <button type="submit" class="btn btn-primary" id="submitBtn">
              Evaluate
            </button>
            <div id="status" class="text-secondary small"></div>
          </div>
        </form>
      </div>
    </div>

    <div id="resultArea" class="d-none">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title mb-3">Result</h5>

          <div class="row g-3">
            <div class="col-md-6">
              <h6>Source</h6>
              <div id="srcSummary" class="small text-secondary"></div>
            </div>
            <div class="col-md-6">
              <h6>Destination</h6>
              <div id="dstSummary" class="small text-secondary"></div>
            </div>
          </div>

          <hr />

          <div class="mb-2">
            <span class="fw-semibold">PCI Impact:</span>
            <span id="pciImpact" class="ms-1"></span>
          </div>
          <div class="mb-2">
            <span class="fw-semibold">Notes:</span>
            <span id="notes" class="ms-1 text-secondary"></span>
          </div>
        </div>
      </div>

      <details class="mb-3">
        <summary class="text-secondary">Show raw response</summary>
        <pre id="rawResponse"></pre>
      </details>
    </div>

    <div id="errorArea" class="d-none">
      <div class="alert alert-danger" role="alert" id="errorText"></div>
    </div>
  </div>

  <script>
    // Use the URL you already tested in PowerShell
    const FUNCTION_URL = "https://az-dev-cyber-pci-function-app.azurewebsites.net/api/FirewallCheck?code=MBX0w4Bm6zZl4LZIZHJtS7f8nEoJo13QuHbr41GFQpdLAzFu27tNpg==";

    const form = document.getElementById("firewallForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    const resultArea = document.getElementById("resultArea");
    const errorArea = document.getElementById("errorArea");
    const errorText = document.getElementById("errorText");

    const srcSummary = document.getElementById("srcSummary");
    const dstSummary = document.getElementById("dstSummary");
    const pciImpactEl = document.getElementById("pciImpact");
    const notesEl = document.getElementById("notes");
    const rawResponseEl = document.getElementById("rawResponse");

    function zoneBadge(zone) {
      if (!zone) return '<span class="zone-badge zone-none">Unknown</span>';
      if (zone === "CDE")
        return '<span class="zone-badge zone-CDE">CDE</span>';
      if (zone === "CSE")
        return '<span class="zone-badge zone-CSE">CSE</span>';
      return '<span class="zone-badge zone-none">' + zone + "</span>";
    }

    function formatEndpoint(label, ip, seg) {
      if (!seg) {
        return (
          "<div><strong>" + label + ":</strong> " + ip + "</div>" +
          "<div>No matching segment found in PCI index.</div>"
        );
      }
      return (
        "<div><strong>" + label + ":</strong> " + ip + " " + zoneBadge(seg.zone) + "</div>" +
        "<div>" + (seg.segment_name || "Unknown segment") + " (" + (seg.cidr || "?") + ")</div>" +
        "<div>" + (seg.location || "") + "</div>"
      );
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      errorArea.classList.add("d-none");
      resultArea.classList.add("d-none");
      statusEl.textContent = "Calling firewall helper API...";
      submitBtn.disabled = true;

      var srcIp = document.getElementById("srcIp").value.trim();
      var dstIp = document.getElementById("dstIp").value.trim();

      var payload = { srcIp: srcIp, dstIp: dstIp };

      try {
        var res = await fetch(FUNCTION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        var text = await res.text();
        var data;
        try {
          data = text ? JSON.parse(text) : null;
        } catch (e) {
          throw new Error("API returned non-JSON response: " + text);
        }

        if (!res.ok) {
          throw new Error(
            data && data.error ? data.error : "API error: " + res.status
          );
        }

        srcSummary.innerHTML = formatEndpoint("Source", data.srcIp, data.src);
        dstSummary.innerHTML = formatEndpoint("Destination", data.dstIp, data.dst);
        pciImpactEl.textContent = data.pciImpact || "Unknown";
        notesEl.textContent = data.notes || "";

        rawResponseEl.textContent = JSON.stringify(data, null, 2);

        resultArea.classList.remove("d-none");
        statusEl.textContent = "Done.";
      } catch (err) {
        errorText.textContent = err.message || String(err);
        errorArea.classList.remove("d-none");
        statusEl.textContent = "Error.";
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
